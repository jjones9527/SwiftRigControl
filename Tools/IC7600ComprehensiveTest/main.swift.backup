import Foundation
import RigControl

/// Comprehensive IC-7600 CI-V Command Test Suite
/// Tests all implemented commands and logs discrepancies for troubleshooting
@main
struct IC7600ComprehensiveTest {

    // MARK: - Test Configuration

    struct TestConfig {
        let serialPort: String
        let baudRate: Int
        let logFilePath: String

        init(serialPort: String, baudRate: Int) {
            self.serialPort = serialPort
            self.baudRate = baudRate

            let timestamp = ISO8601DateFormatter().string(from: Date()).replacingOccurrences(of: ":", with: "-")
            self.logFilePath = "/tmp/ic7600_test_\(timestamp).log"
        }
    }

    // MARK: - Logger

    class TestLogger {
        private let fileHandle: FileHandle
        private let config: TestConfig

        init(config: TestConfig) throws {
            self.config = config

            // Create log file
            if !FileManager.default.fileExists(atPath: config.logFilePath) {
                FileManager.default.createFile(atPath: config.logFilePath, contents: nil)
            }

            guard let handle = FileHandle(forWritingAtPath: config.logFilePath) else {
                throw NSError(domain: "TestLogger", code: 1, userInfo: [NSLocalizedDescriptionKey: "Could not open log file"])
            }

            self.fileHandle = handle
            try fileHandle.seekToEnd()

            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            log("IC-7600 Comprehensive CI-V Command Test")
            log("Test Started: \(Date())")
            log("Serial Port: \(config.serialPort)")
            log("Baud Rate: \(config.baudRate)")
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        }

        func log(_ message: String) {
            let timestamped = "[\(timestamp())] \(message)"
            print(timestamped)

            if let data = (timestamped + "\n").data(using: .utf8) {
                fileHandle.write(data)
            }
        }

        func logCommand(_ cmd: String, sent: String, received: String, expected: String, actual: String, match: Bool) {
            log("")
            log("Command: \(cmd)")
            log("  Sent Frame: \(sent)")
            log("  Received Frame: \(received)")
            log("  Expected Result: \(expected)")
            log("  Actual Result: \(actual)")
            log("  Status: \(match ? "âœ… PASS" : "âŒ FAIL - DISCREPANCY DETECTED")")

            if !match {
                log("  >>> DISCREPANCY: User should verify radio display")
            }
        }

        func logError(_ cmd: String, error: Error) {
            log("")
            log("Command: \(cmd)")
            log("  âŒ ERROR: \(error)")
        }

        func logSection(_ title: String) {
            log("")
            log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
            log(title)
            log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        }

        private func timestamp() -> String {
            let formatter = DateFormatter()
            formatter.dateFormat = "HH:mm:ss.SSS"
            return formatter.string(from: Date())
        }

        func close() {
            log("")
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            log("Test Completed: \(Date())")
            log("Log saved to: \(config.logFilePath)")
            log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
            fileHandle.closeFile()
        }

        deinit {
            fileHandle.closeFile()
        }
    }

    // MARK: - User Input Helper

    static func getUserInput(_ prompt: String) -> String {
        print(prompt, terminator: "")
        return readLine()?.trimmingCharacters(in: .whitespacesAndNewlines) ?? ""
    }

    static func getUserConfirmation(_ prompt: String) -> Bool {
        let response = getUserInput("\(prompt) (y/n): ")
        return response.lowercased() == "y" || response.lowercased() == "yes"
    }

    // MARK: - Main Test Entry Point

    static func main() async {
        print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘     IC-7600 Comprehensive CI-V Command Test Suite         â•‘")
        print("â•‘     SwiftRigControl v1.1.0                                 â•‘")
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print()

        // Get serial port configuration
        print("Please enter the IC-7600 serial port path")
        print("Example: /dev/cu.usbserial-2120")
        let serialPort = getUserInput("Serial Port: ")

        guard !serialPort.isEmpty else {
            print("âŒ Error: Serial port cannot be empty")
            return
        }

        print("\nPlease enter the baud rate")
        print("IC-7600 default: 19200")
        let baudRateStr = getUserInput("Baud Rate (default 19200): ")
        let baudRate = Int(baudRateStr) ?? 19200

        let config = TestConfig(serialPort: serialPort, baudRate: baudRate)

        do {
            let logger = try TestLogger(config: config)

            // Setup instructions
            print("\n" + String(repeating: "=", count: 60))
            print("RADIO SETUP REQUIRED")
            print(String(repeating: "=", count: 60))
            print("\nPlease configure your IC-7600 to the following state:")
            print("  â€¢ Main Band: 14.200 MHz")
            print("  â€¢ Main Mode: USB (FIL1)")
            print("  â€¢ Sub Band: 7.100 MHz")
            print("  â€¢ Sub Mode: LSB (FIL1)")
            print("  â€¢ Split: OFF")
            print("  â€¢ RF Power: 50W (50%)")
            print("  â€¢ Attenuator: OFF")
            print("  â€¢ Preamp: OFF")
            print("  â€¢ AGC: FAST")
            print("  â€¢ Noise Blanker: OFF")
            print("  â€¢ Noise Reduction: OFF")
            print()

            guard getUserConfirmation("Is the radio configured as above?") else {
                print("Test cancelled by user")
                logger.close()
                return
            }

            logger.log("User confirmed radio setup complete")

            // Create RigController
            let rig = RigController(
                radio: .icomIC7600,
                connection: .serial(path: config.serialPort, baudRate: config.baudRate)
            )

            // Connect
            logger.logSection("CONNECTING TO IC-7600")
            try await rig.connect()
            logger.log("âœ… Connected successfully")
            print("\nâœ… Connected to IC-7600")

            // Run test suite
            await runTestSuite(rig: rig, logger: logger)

            // Disconnect
            logger.logSection("DISCONNECTING")
            await rig.disconnect()
            logger.log("âœ… Disconnected")

            logger.close()
            print("\nâœ… Test completed successfully")
            print("ðŸ“„ Log file: \(config.logFilePath)")

        } catch {
            print("\nâŒ Fatal error: \(error)")
            Foundation.exit(1)
        }
    }

    // MARK: - Test Suite

    static func runTestSuite(rig: RigController, logger: TestLogger) async {
        // Test 1: Read Initial State
        await testReadInitialState(rig: rig, logger: logger)

        // Test 2: Frequency Operations
        await testFrequencyOperations(rig: rig, logger: logger)

        // Test 3: Mode Operations
        await testModeOperations(rig: rig, logger: logger)

        // Test 4: VFO Operations
        await testVFOOperations(rig: rig, logger: logger)

        // Test 5: Split Operations
        await testSplitOperations(rig: rig, logger: logger)

        // Test 6: Power Operations
        await testPowerOperations(rig: rig, logger: logger)

        // Test 7: PTT Operations
        await testPTTOperations(rig: rig, logger: logger)

        // Test 8: Signal Strength Reading
        await testSignalStrength(rig: rig, logger: logger)
    }

    // MARK: - Test 1: Read Initial State

    static func testReadInitialState(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 1: READ INITIAL STATE")

        do {
            // Read main frequency
            let mainFreq = try await rig.frequency(vfo: VFO.main, cached: false)
            let mainFreqMHz = Double(mainFreq) / 1_000_000.0

            let userFreq = getUserInput("What frequency does MAIN band display show? (MHz): ")
            let match1 = userFreq.contains(String(format: "%.3f", mainFreqMHz).prefix(6))

            logger.logCommand(
                "Read Main Frequency (0x03)",
                sent: "FE FE 7A E0 03 FD",
                received: "[Response with BCD frequency]",
                expected: "14.200 MHz",
                actual: String(format: "%.6f MHz", mainFreqMHz),
                match: match1
            )

            // Read main mode
            let mainMode = try await rig.mode(vfo: VFO.main, cached: false)

            let userMode = getUserInput("What mode does MAIN band display show? (LSB/USB/AM/FM/CW/RTTY): ")
            let match2 = userMode.lowercased() == mainMode.rawValue.lowercased()

            logger.logCommand(
                "Read Main Mode (0x04)",
                sent: "FE FE 7A E0 04 FD",
                received: "[Response with mode code]",
                expected: "USB",
                actual: mainMode.rawValue,
                match: match2
            )

        } catch {
            logger.logError("Read Initial State", error: error)
        }
    }

    // MARK: - Test 2: Frequency Operations

    static func testFrequencyOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 2: FREQUENCY OPERATIONS")

        // Test 2.1: Set Main Frequency to 21.225 MHz
        do {
            logger.log("\nTest 2.1: Set Main Frequency to 21.225 MHz")
            try await rig.setFrequency(21_225_000, vfo: VFO.main)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.frequency(vfo: VFO.main, cached: false)
            let readbackMHz = Double(readback) / 1_000_000.0

            let userFreq = getUserInput("What frequency does MAIN band display show now? (MHz): ")
            let match = userFreq.contains("21.225")

            logger.logCommand(
                "Set Main Frequency to 21.225 MHz (0x05)",
                sent: "FE FE 7A E0 05 [00 00 21 22 50 00] FD",
                received: "FE FE E0 7A FB FD",
                expected: "21.225000 MHz",
                actual: String(format: "%.6f MHz", readbackMHz),
                match: match
            )

        } catch {
            logger.logError("Set Main Frequency", error: error)
        }

        // Test 2.2: Set Sub Frequency to 3.750 MHz
        do {
            logger.log("\nTest 2.2: Set Sub Frequency to 3.750 MHz")
            try await rig.setFrequency(3_750_000, vfo: VFO.sub)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.frequency(vfo: VFO.sub, cached: false)
            let readbackMHz = Double(readback) / 1_000_000.0

            let userFreq = getUserInput("What frequency does SUB band display show now? (MHz): ")
            let match = userFreq.contains("3.750")

            logger.logCommand(
                "Set Sub Frequency to 3.750 MHz (0x05)",
                sent: "FE FE 7A E0 05 [00 00 03 75 00 00] FD",
                received: "FE FE E0 7A FB FD",
                expected: "3.750000 MHz",
                actual: String(format: "%.6f MHz", readbackMHz),
                match: match
            )

        } catch {
            logger.logError("Set Sub Frequency", error: error)
        }

        // Test 2.3: Return Main to 14.200 MHz
        do {
            logger.log("\nTest 2.3: Return Main to 14.200 MHz")
            try await rig.setFrequency(14_200_000, vfo: VFO.main)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.frequency(vfo: VFO.main, cached: false)
            let readbackMHz = Double(readback) / 1_000_000.0

            logger.log("Software reports: \(String(format: "%.6f MHz", readbackMHz))")

        } catch {
            logger.logError("Return Main Frequency", error: error)
        }
    }

    // MARK: - Test 3: Mode Operations

    static func testModeOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 3: MODE OPERATIONS (KNOWN ISSUE)")

        logger.log("NOTE: Mode setting is currently failing with NAK response")
        logger.log("This test will attempt mode changes and log results for debugging")

        // Test 3.1: Set Main to LSB
        do {
            logger.log("\nTest 3.1: Attempt to set Main to LSB")
            logger.log("Current mode before change:")
            let beforeMode = try await rig.mode(vfo: VFO.main, cached: false)
            logger.log("  Software reports: \(beforeMode.rawValue)")

            do {
                try await rig.setMode(Mode.lsb, vfo: VFO.main)
                try await Task.sleep(for: .milliseconds(300))

                let afterMode = try await rig.mode(vfo: VFO.main, cached: false)
                let userMode = getUserInput("What mode does MAIN band show now? (LSB/USB/etc): ")
                let match = userMode.lowercased() == "lsb"

                logger.logCommand(
                    "Set Main Mode to LSB (0x06)",
                    sent: "FE FE 7A E0 06 00 00 FD",
                    received: "FE FE E0 7A FB FD (expected ACK)",
                    expected: "LSB",
                    actual: afterMode.rawValue,
                    match: match
                )

            } catch {
                logger.log("  âŒ Command rejected (as expected)")
                logger.log("  Error: \(error)")
                logger.log("  Radio should still show: USB")

                let userMode = getUserInput("What mode does MAIN band show? (Should be USB): ")
                logger.log("  User reports: \(userMode)")
                logger.log("  >>> This confirms the known mode setting issue")
            }

        } catch {
            logger.logError("Mode Operations Setup", error: error)
        }

        // Test 3.2: Try with filter byte 0x01
        logger.log("\nTest 3.2: Testing with different filter values")
        logger.log("NOTE: This requires code modification to test different filter bytes")
        logger.log("Current implementation hardcoded filter to 0x00")
        logger.log("Hamlib and manual suggest 0x01 (FIL1) should be used")
        logger.log("âœ… FIXED: Modified setModeCommand to use filter 0x01 (FIL1)")
    }

    // MARK: - Test 4: VFO Operations

    static func testVFOOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 4: VFO OPERATIONS")

        // Test 4.1: Select Main Band
        do {
            logger.log("\nTest 4.1: Select Main Band")
            try await rig.selectVFO(VFO.main)
            try await Task.sleep(for: .milliseconds(300))

            let userSelection = getUserInput("Which band is now selected (MAIN/SUB)? ")
            let match = userSelection.lowercased().contains("main")

            logger.logCommand(
                "Select Main Band (0x07 0xD0)",
                sent: "FE FE 7A E0 07 D0 FD",
                received: "FE FE E0 7A FB FD",
                expected: "MAIN band selected",
                actual: userSelection,
                match: match
            )

        } catch {
            logger.logError("Select Main Band", error: error)
        }

        // Test 4.2: Select Sub Band
        do {
            logger.log("\nTest 4.2: Select Sub Band")
            try await rig.selectVFO(VFO.sub)
            try await Task.sleep(for: .milliseconds(300))

            let userSelection = getUserInput("Which band is now selected (MAIN/SUB)? ")
            let match = userSelection.lowercased().contains("sub")

            logger.logCommand(
                "Select Sub Band (0x07 0xD1)",
                sent: "FE FE 7A E0 07 D1 FD",
                received: "FE FE E0 7A FB FD",
                expected: "SUB band selected",
                actual: userSelection,
                match: match
            )

        } catch {
            logger.logError("Select Sub Band", error: error)
        }

        // Test 4.3: Return to Main
        do {
            logger.log("\nTest 4.3: Return to Main Band")
            try await rig.selectVFO(VFO.main)
            try await Task.sleep(for: .milliseconds(300))
            logger.log("Returned to main band for subsequent tests")

        } catch {
            logger.logError("Return to Main Band", error: error)
        }
    }

    // MARK: - Test 5: Split Operations

    static func testSplitOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 5: SPLIT OPERATIONS")

        // Test 5.1: Enable Split
        do {
            logger.log("\nTest 5.1: Enable Split")
            try await rig.setSplit(true)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.isSplitEnabled()
            let userSplit = getUserConfirmation("Is SPLIT indicator showing on the display?")
            let match = readback == userSplit

            logger.logCommand(
                "Enable Split (0x0F 0x01)",
                sent: "FE FE 7A E0 0F 01 FD",
                received: "FE FE E0 7A FB FD",
                expected: "Split ON",
                actual: readback ? "Split ON" : "Split OFF",
                match: match
            )

        } catch {
            logger.logError("Enable Split", error: error)
        }

        // Test 5.2: Disable Split
        do {
            logger.log("\nTest 5.2: Disable Split")
            try await rig.setSplit(false)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.isSplitEnabled()
            let userSplit = getUserConfirmation("Is SPLIT indicator showing on the display?")
            let match = readback == userSplit

            logger.logCommand(
                "Disable Split (0x0F 0x00)",
                sent: "FE FE 7A E0 0F 00 FD",
                received: "FE FE E0 7A FB FD",
                expected: "Split OFF",
                actual: readback ? "Split ON" : "Split OFF",
                match: match
            )

        } catch {
            logger.logError("Disable Split", error: error)
        }
    }

    // MARK: - Test 6: Power Operations

    static func testPowerOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 6: POWER OPERATIONS")

        // Test 6.1: Read Power
        do {
            logger.log("\nTest 6.1: Read Current Power Level")
            let power = try await rig.power()

            let userPower = getUserInput("What power level (in watts) does the display show? ")
            let match = abs(Int(userPower) ?? 0 - power) <= 5  // Allow 5W tolerance

            logger.logCommand(
                "Read Power Level (0x14 0x0A)",
                sent: "FE FE 7A E0 14 0A FD",
                received: "[Response with power level]",
                expected: "~50W",
                actual: "\(power)W",
                match: match
            )

        } catch {
            logger.logError("Read Power", error: error)
        }

        // Test 6.2: Set Power to 25W
        do {
            logger.log("\nTest 6.2: Set Power to 25W")
            try await rig.setPower(25)
            try await Task.sleep(for: .milliseconds(300))

            let readback = try await rig.power()
            let userPower = getUserInput("What power level (in watts) does the display show now? ")
            let match = abs(Int(userPower) ?? 0 - 25) <= 5

            logger.logCommand(
                "Set Power to 25W (0x14 0x0A)",
                sent: "FE FE 7A E0 14 0A [level bytes] FD",
                received: "FE FE E0 7A FB FD",
                expected: "25W",
                actual: "\(readback)W",
                match: match
            )

        } catch {
            logger.logError("Set Power to 25W", error: error)
        }

        // Test 6.3: Restore Power to 50W
        do {
            logger.log("\nTest 6.3: Restore Power to 50W")
            try await rig.setPower(50)
            try await Task.sleep(for: .milliseconds(300))
            logger.log("Power restored to 50W")

        } catch {
            logger.logError("Restore Power", error: error)
        }
    }

    // MARK: - Test 7: PTT Operations

    static func testPTTOperations(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 7: PTT OPERATIONS")

        logger.log("âš ï¸  WARNING: This test will key the transmitter!")
        logger.log("Please ensure:")
        logger.log("  â€¢ Antenna or dummy load is connected")
        logger.log("  â€¢ Frequency is clear")
        logger.log("  â€¢ Power is set to safe level (50W)")

        guard getUserConfirmation("\nProceed with PTT test?") else {
            logger.log("PTT test skipped by user")
            return
        }

        // Test 7.1: Read PTT State (should be RX)
        do {
            logger.log("\nTest 7.1: Read PTT State (expecting RX)")
            let pttState = try await rig.isPTTEnabled()

            let userTX = getUserConfirmation("Is the radio transmitting (TX light ON)?")
            let match = pttState == userTX

            logger.logCommand(
                "Read PTT State (0x1C 0x00)",
                sent: "FE FE 7A E0 1C 00 FD",
                received: "[00=RX, 01=TX]",
                expected: "RX (false)",
                actual: pttState ? "TX (true)" : "RX (false)",
                match: match
            )

        } catch {
            logger.logError("Read PTT State", error: error)
        }

        // Test 7.2: Enable PTT (TX)
        do {
            logger.log("\nTest 7.2: Enable PTT for 1 second")
            logger.log("Transmitting in 3 seconds...")
            try await Task.sleep(for: .seconds(3))

            try await rig.setPTT(true)
            logger.log("ðŸ“¡ TRANSMITTING...")

            let userTX = getUserConfirmation("Is TX light ON and radio transmitting?")

            logger.logCommand(
                "Enable PTT (0x1C 0x00 0x01)",
                sent: "FE FE 7A E0 1C 00 01 FD",
                received: "FE FE E0 7A FB FD",
                expected: "TX",
                actual: userTX ? "TX" : "RX",
                match: userTX
            )

            try await Task.sleep(for: .seconds(1))

        } catch {
            logger.logError("Enable PTT", error: error)
        }

        // Test 7.3: Disable PTT (RX)
        do {
            logger.log("\nTest 7.3: Disable PTT (return to RX)")
            try await rig.setPTT(false)
            try await Task.sleep(for: .milliseconds(300))

            let userRX = !getUserConfirmation("Is TX light still ON?")

            logger.logCommand(
                "Disable PTT (0x1C 0x00 0x00)",
                sent: "FE FE 7A E0 1C 00 00 FD",
                received: "FE FE E0 7A FB FD",
                expected: "RX",
                actual: userRX ? "RX" : "TX",
                match: userRX
            )

            logger.log("âœ… PTT test complete, radio returned to RX")

        } catch {
            logger.logError("Disable PTT", error: error)
        }
    }

    // MARK: - Test 8: Signal Strength

    static func testSignalStrength(rig: RigController, logger: TestLogger) async {
        logger.logSection("TEST 8: SIGNAL STRENGTH READING")

        do {
            logger.log("\nReading S-meter level...")
            let signal = try await rig.signalStrength(cached: false)

            let userSMeter = getUserInput("What S-meter reading does the display show? (e.g., S3, S9, S9+20): ")
            logger.log("User reports: \(userSMeter)")
            logger.log("Software reports: S\(signal.sUnits)" + (signal.overS9 > 0 ? "+\(signal.overS9)dB" : ""))

            logger.logCommand(
                "Read S-meter (0x15 0x02)",
                sent: "FE FE 7A E0 15 02 FD",
                received: "[Response with S-meter value]",
                expected: userSMeter,
                actual: "\(signal.sUnits) S-units",
                match: true  // Manual verification
            )

        } catch {
            logger.logError("Read Signal Strength", error: error)
        }
    }
}
